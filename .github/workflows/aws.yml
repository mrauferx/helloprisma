name: Build and Deploy to AWS
on:
#  push:
#    branches:
#      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      id-token: write

    env:
      JAVA_HOME: JAVA_HOME_11_X64
      IMAGE_NAME: ${{ github.repository }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      # node.js required for code scan, already installed in runner ...

      # required if using Cortex CLI scanner - activate later, v0.14.0 not working properly ...
      #- name: Download cortexcli
      #  run: |
      #    curl -s -o cortexcli $(curl -s "${{ secrets.CORTEX_API_URL }}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
      #      -H "x-xdr-auth-id: ${{ secrets.CORTEX_API_KEY_ID }}" -H "Authorization: ${{ secrets.CORTEX_API_KEY }}" | jq -r ".signed_url")
      #    chmod +x cortexcli
      #    ./cortexcli --version
          # ls -la .cortexcli
          # sudo apt-get update
          # sudo apt-get install -y libhyperscan5

      # using Cortex CLI scanner - activate later, v0.14.0 not working properly ...
      #- name: Scan Code
      #  run: |
      #    ./cortexcli \
      #      --api-base-url ${{ secrets.CORTEX_API_URL }} \
      #      --api-key ${{ secrets.CORTEX_API_KEY }} \
      #      --api-key-id ${{ secrets.CORTEX_API_KEY_ID }} \
      #      code scan \
      #      --directory ${{ github.workspace }} \
      #      --repo-id ${{github.repository}} \
      #      --branch ${{github.ref_name}} \
      #      --source 'GITHUB_ACTIONS' \
      #      --create-repo-if-missing \
      #      --upload-mode upload

      # prepare build for Azure - not needed, Docker works as-is (for now)
      #- name: Set up Docker Buildx
      #  uses: docker/setup-buildx-action@v3

      # set up versioning variables to push multiple tags
      - name: Set image tags
        id: vars
        run: |
          echo "BUILD_NUMBER=${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV
          #echo "GIT_SHA=$(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV
          #echo "TAGS=latest ${GITHUB_RUN_NUMBER} $(echo $GITHUB_SHA | cut -c1-7)" >> $GITHUB_ENV
          echo "TAGS=latest ${GITHUB_RUN_NUMBER}" >> $GITHUB_ENV

      # build Docker image once for both ACR and ECR
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME:latest .

      - name: Test Image
        run: |
          docker images |grep $IMAGE_NAME
          echo "Tests passed."

      # java required for image scan, already installed in runner (referenced via JAVA_HOME) ...

      # using Cortex CLI scanner - activate later, v0.14.0 not working properly ...
      #- name: Scan Image
      #  run: |
      #    ./cortexcli \
      #      --api-base-url ${{ secrets.CORTEX_API_URL }} \
      #      --api-key ${{ secrets.CORTEX_API_KEY }} \
      #      --api-key-id ${{ secrets.CORTEX_API_KEY_ID }} \
      #      --soft-fail \
      #      image scan \
      #      --ci-pipeline-id "${{ github.workflow }}" \
      #      --ci-build-id ${{ github.run_number }} \
      #      --name "$IMAGE_NAME:latest" \
      #      --output-format json \
      #      --timeout 240 \
      #      $IMAGE_NAME:latest
            #cat /tmp/cortexcli-*.log
            #--log-level ERROR \
            #--upload-mode upload \
                      
      #- name: Archive Scan Results
      #  uses: actions/upload-artifact@v4
      #  with:
      #    name: image-scan-report
      #    path: /tmp/${{ github.repository }}-${{ github.run_number }}-scan.json
      #    retention-days: 20                                                # 90 is the default          

      # using Cortex CLI scanner - activate later, v0.14.0 not working properly ...
      #- name: Generate Image SBOM
      #  run: |
      #    ./cortexcli \
      #      --api-base-url ${{ secrets.CORTEX_API_URL }} \
      #      --api-key ${{ secrets.CORTEX_API_KEY }} \
      #      --api-key-id ${{ secrets.CORTEX_API_KEY_ID }} \
      #      image sbom \
      #      --output-file ./artifacts/helloprisma-${{ github.run_number }}-sbom.json \
      #      $IMAGE_NAME:latest
            # --log-level ERROR

      #- name: Archive Image SBOM
      #  uses: actions/upload-artifact@v4
      #  with:
      #    name: sbom-manifests
      #    path: ./artifacts/helloprisma-${{ github.run_number }}-sbom.json
      #    retention-days: 20                                                # 90 is the default

      # new image push to ECR
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Push image to ECR with all tags
        run: |
          ECR_URI=${{ steps.login-ecr.outputs.registry }}
          for TAG in $TAGS; do
            ECR_TAG=$ECR_URI/$IMAGE_NAME:$TAG
            docker tag $IMAGE_NAME:latest $ECR_TAG
            docker push $ECR_TAG
          done

      # display summary, can be removed later ...
      #- name: Show pushed image tags
      #  run: |
      #    echo "âœ… Image $IMAGE_NAME pushed to Azure ACR and to AWS ECR (later) with tags:"
      #    for TAG in $TAGS; do
      #      echo " - $TAG"
      #    done

      - name: Set up kubectl for EKS
        run: |
          aws eks update-kubeconfig --name ${{ secrets.AWS_EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_REGION }}

      - name: Deploy Application to EKS
        run: |
          ECR_URI=${{ steps.login-ecr.outputs.registry }}
          helm upgrade \
          ${{ github.event.repository.name }} \
          helm \
          --install \
          --create-namespace \
          --namespace ${{ github.event.repository.name }} \
          --set image.repository=$ECR_URI/$IMAGE_NAME \
          --set image.tag=${{ github.run_number }} \
          --set-string service.annotations."service\.beta\.kubernetes\.io/aws-load-balancer-additional-resource-tags"="Environment=Non-prod\,IdentifierCode=PANW-Demo-Lab\,Tenancy=Dedicated" \
          --set dockerConfigJson.data="$(cat ~/.docker/config.json | base64 -w 0)"
